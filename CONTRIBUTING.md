# Contributing to Katamari

このリポジトリは個人でメンテナンスしている OSS です。変更は最小限・高品質に保ちつつ、誰もが継続的に改善へ参加できるよう以下のルールを設けています。

## ブランチ運用
- `main` は常にデプロイ可能な状態を維持します。日々の開発は `feature/<課題>-<要約>`、不具合修正は `fix/<課題>-<要約>`、緊急 hotfix は `hotfix/<課題>-<要約>` のように接頭辞で目的を明示してください。複数のスコープを扱う場合はタスクごとにブランチを分け、100 行を超える差分はサブタスクを起票して分割します。
- Issue を起票した場合はブランチ名・コミットメッセージ双方に Issue 番号を含めると追跡が容易です（例: `feature/1234-add-ci-lint`）。Issue のチェックリストと PR のチェックリストは同じ順序で更新し、未完了項目は Draft のままにします。
- 作業開始時と PR 作成前に `git fetch origin && git rebase origin/main` を実施し、Force push が発生する場合はレビュー担当へ事前通知します。コンフリクト解消時は双方の意図をノート 1 行で記録してください。
- コミットは小さく意味のある単位に分割し、PR も 300 行未満を目安にスコープを抑えてください。大規模変更はタスク分割やドラフト PR で早期共有します。バイナリや生成物はコミットしないでください。
- 長期ブランチでは週次で `origin/main` を取り込み、仕様変更や依存更新の差分を早めに吸収します。CI が導入されている場合はリベース後にローカルで同じチェックを再実行します。

## 開発環境セットアップ
1. Python 依存関係を `pip install -r requirements.txt` で導入します。評価用ツールが必要な場合は `requirements-eval.txt` も参照してください。
2. Node.js まわりを触る場合は `pnpm install` を実行してください。
3. pre-commit を使用する場合は `pip install pre-commit && pre-commit install` でフックを設定できます。
4. 追加のセットアップが必要なときは `RUNBOOK.md` と `docs/` を参照してください。

## テストと Lint の実行
TDD を推奨し、実装前にテストを追加してからコードを変更してください。Python/Node 双方で型安全と ESM/TS のポリシーを守るため、以下のマトリクスを基本フローとします。

| 対象 | コマンド | 備考 |
| --- | --- | --- |
| Python | `ruff check .` | 自動整形は `ruff format .` を利用可。ruff の警告はゼロに保つ |
| Python 型チェック | `mypy --strict` | 例外ハンドリングと型境界は仕様に準拠し、Optional/Union は必要最小限 |
| Python テスト | `pytest -q` | 追加分は `tests/` へ。失敗時は原因と再現手順を Issue/PR に明記 |
| Node/フロントエンド | `pnpm run lint` | ESM/TS ルールに合致するよう import を整理し、循環依存を避ける |
| Node テスト | `pnpm run test` | `node:test` ベースのケースを最初に追加。スナップショットは安定化させる |
| 共通 | `make check` | 導入済みの場合は最終確認として実行し、ログを PR に添付 |

PR テンプレートの「テスト実行ログ」欄には成功を確認できる 1 行以上の結果を貼り付けてください。対象外の領域は「対象外」と明記します。

### 変更前後で守るべき互換性
- CLI/JSON 出力の破壊的変更は行わないでください。やむを得ず変更する場合はフラグで段階移行し、`docs/` にマイグレーション手順を追記します。
- 例外は既存のエラーハイアラキーに合わせ、再試行可否が呼び出し側で判定できるよう型情報を付与します。
- 実装コストやレイテンシの変動は ±5% 以内を目指し、超過が見込まれる場合は代替案を「Notes」欄に 1 行で提案します。

### テスト駆動での提出フロー
1. 仕様差分を確認し、守るべき例外ポリシーや CLI/JSON の互換条件を洗い出します。
2. 先に失敗するテスト（Python: `tests/`、Node: `tests/`）を追加し、`pytest -q` や `pnpm run test` が失敗することを確認します。
3. 実装を行い、上表のコマンドに加えて `ruff format .`（必要時）、`git status --short` で余計な差分がないかを確認します。コミット前に `pytest -q` と `pnpm run test` のグリーンを再確認してください。
4. 全コマンドがグリーンになったらログを PR テンプレートへ貼り付け、レビュー観点とリスクを簡潔に記述します。

## ADR を追加・更新する手順
1. `docs/adr/0000-template.md` をコピーし、`docs/adr/NNNN-<要約>.md`（4 桁ゼロ埋め）というファイル名で保存します。番号は `docs/adr/README.md` の最新値から連番で採番します。
2. テンプレートの `Metadata` セクション（番号・作成日・作成者）と `Context`/`Decision`/`Consequences`/`Status`/`DoD` をすべて埋めます。背景リンク・採用理由・DoD チェックリストは必須で、マイルストーン ADR の場合は `docs/katamari_wbs.csv` と整合させます。
3. 既存 ADR や仕様書への参照がある場合はリンクを貼り、フォローアップタスクがあるときは `DoD` のチェック項目に「Follow-up」として明記します。必要に応じて `docs/adr/README.md` にステータス更新日を反映させます。
4. `docs/adr/README.md` と関連ハブ（[`docs/ROADMAP_AND_SPECS.md#adr-インデックスコア判断とマイルストーン`](docs/ROADMAP_AND_SPECS.md#adr-インデックスコア判断とマイルストーン)）のテーブル・リンクを更新し、新旧の整合性を確認します。
5. PR では本手順を満たしたことを記載し、レビュワーが DoD の達成状況を検証できるよう関連テストや証跡を提示します。

## コミットと Pull Request
- コミットメッセージは簡潔な日本語または英語で要点を 1 行にまとめ、必要に応じて本文で背景を補足します。
- Pull Request はテンプレートを必ず使用し、未対応の項目は「未実施」「対象外」など明示的に記入してください。
- テンプレートの各セクション（Summary / Testing / Checklist / Notes）を削除せず、`✅`/`⚠️`/`❌` の絵文字とともに実行コマンドを記載してください。対象外の場合は理由を併記します。
- 変更点、動作確認、影響範囲、レビューしてほしいポイントをそれぞれ短く記述するとレビューがスムーズです。
- Draft PR は作業メモとして活用して構いません。レビュー準備が整ったら Ready for review へ切り替えてください。
- PR 作成時は以下を満たしてください。
  - 「What」: 目的・主要変更を箇条書きで記述。
  - 「Why」: 背景・課題・関連 Issue を記述。
  - 「Test」: 実行したコマンドに ✅/⚠️/❌ を添えて記録。未実施は理由とともに「対象外」。
  - 「Notes」: レビュー依頼事項やフォローアップタスクを列挙。

## 改行ポリシー
- ルートの `.gitattributes` で `* text=auto` を設定し、シェルスクリプト（`*.sh` など）・Python（`*.py`）・PowerShell（`*.ps1`/`*.psm1`/`*.psd1`）・Makefile（`Makefile`/`*.mk`）は LF へ統一しています。
- `.gitattributes` を更新した際は `git diff --stat` や `git status --short` で影響範囲を確認し、改行差分が期待通りかを必ずチェックしてください。
- CRLF → LF の大量変更が必要になった場合は `git add --renormalize .` を実行して整えますが、結果は通常の差分と分離した別コミット（例: `chore: normalize line endings`）で扱ってください。
- 新規ファイルや外部から持ち込むコードも `.gitattributes` のポリシーに合わせ、CRLF が混入していないかをコミット前に確認してください。

## レビューとマージ
- レビューは基本的にメンテナーが行いますが、CODEOWNERS に指定された担当者が追加レビューを行う場合があります。
- 指摘に対する修正は追加コミットで行い、最終的に `git rebase -i` で整理しても構いません（強制 push の際は通知を忘れずに）。
- CI が導入されている場合はすべてのチェックが成功していることを確認してください。

## コミュニケーション
- 大きめの設計変更や互換性に影響する変更を検討する際は、先に Issue や Discussion で方針を共有してもらえると助かります。
- 機密情報（API キー等）はコミットに含めないでください。
- わからない点や迷った点は遠慮なくコメントしてください。ドキュメントの更新だけでも歓迎です。

## 個人 + AI の協働ワークフロー
- リポジトリオーナー（個人メンテナー + Katamari AI）は Task → 実装 → レビューを常にペアで進めます。設計判断は人間が最終決裁し、AI 提案を採用する際は根拠をコミットメッセージか PR に残してください。
- 仕様調査や差分検証を AI に依頼する場合も、`git diff` とテスト結果は人間が最終確認します。AI 生成コードは TDD で担保し、例外設計と型安全性を人間がレビューします。
- セキュリティ・個人情報に関わる議題は人間メンテナーが直接判断します。AI には匿名化した情報のみ渡してください。
- レビューでは AI からのサジェストを Draft コメントとして共有し、人間が承認した部分のみコミットに反映します。
- 緊急対応時は人間メンテナーがブロッカー解消を優先し、AI にはログ整形や再現手順の抽出など補助作業を依頼する運用とします。

継続的な改善への参加を歓迎します。ありがとうございます！
