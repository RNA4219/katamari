# Contributing to Katamari

このリポジトリは個人でメンテナンスしている OSS です。変更は最小限・高品質に保ちつつ、誰もが継続的に改善へ参加できるよう以下のルールを設けています。

## ブランチ運用
- 既定の開発ブランチは `main` です。`main` は常にデプロイ可能な状態を維持し、直接 push せず Pull Request 経由でのみ変更を取り込みます。
- 作業ブランチは `feature/<課題>-<要約>`、`fix/<課題>-<要約>`、`chore/<課題>-<要約>` のように種別 + 課題番号（あれば） + 要約を組み合わせて作成してください（例: `feature/1234-add-ci-lint`）。
- 変更が大きくなる場合は、ブランチを用途別に分割して段階的にマージし、レビュー負荷を抑えます。
- rebase で `main` の最新を取り込み (`git fetch origin && git rebase origin/main`)、CI が通る状態を確認した上でレビューを依頼してください。rebase が難しい場合のみ `git merge origin/main` を利用します。
- リリースブランチやホットフィックスが必要になった場合は、事前に Issue/Discussion で方針を相談してください。運用方法を決めたら `RUNBOOK.md` などに追記します。

## 開発環境セットアップ
1. Python 依存関係を `pip install -r requirements.txt` で導入します。評価用ツールが必要な場合は `requirements-eval.txt` も参照してください。
2. Node.js まわりを触る場合は `pnpm install` を実行してください。
3. pre-commit を使用する場合は `pip install pre-commit && pre-commit install` でフックを設定できます。
4. 追加のセットアップが必要なときは `RUNBOOK.md` と `docs/` を参照してください。

## テストと Lint の実行
TDD を推奨し、実装前にテストを追加してからコードを変更してください。作業ブランチで下表のコマンドをローカル実行し、失敗した場合は修正してからコミットします。CI で実行されるチェックと同等の結果をローカルで確認できるよう、`Makefile` のターゲットも適宜活用してください。

| 対象 | コマンド | 備考 |
| --- | --- | --- |
| Python | `ruff check .` | 自動整形は `ruff format .` を利用可 |
| Python 型チェック | `mypy --strict` | 型エラーをすべて解消してください |
| Python テスト | `pytest -q` | 重要なケースは `tests/` に追加 |
| Node/フロントエンド | `pnpm run lint` | ESM/TS の方針に従いビルドが通ること |
| Node テスト | `pnpm run test` | `node:test` ベースのテストを追加 |
| まとめて実行 | `make check` | 主要な Lint/テストを一括実行 |

PR テンプレートの「テスト実行ログ」欄には成功を確認できる 1 行以上の結果を貼り付けてください。対象外の領域は「対象外」と明記します。CI で初めて失敗が検知された場合は、原因を特定しローカルで再現できる状態まで落とし込むことを目標にしてください。

## コミットと Pull Request
- コミットメッセージは簡潔な日本語または英語で要点を 1 行にまとめ、必要に応じて本文で背景を補足します。テストで検証した範囲はコミットメッセージまたは PR 説明欄に必ず記載してください。
- Pull Request は `.github/PULL_REQUEST_TEMPLATE.md` を必ず使用し、未対応のチェック項目は「未実施」「対象外」など明示的に記入します。テンプレートの構成を変更する場合は別 PR で検討します。
- 「変更点」「テスト」「影響範囲」「レビューしてほしいポイント」をそれぞれ短く記述するとレビューがスムーズです。スクリーンショットやログは必要最小限で結構ですが、UI 変更時は必ず添付してください。
- Draft PR は作業メモとして活用して構いません。レビュー準備が整ったら Ready for review へ切り替えてください。Ready にする際は CI がすべて成功していることを確認してください。

## レビューとマージ
- レビューは基本的にメンテナーが行いますが、CODEOWNERS に指定された担当者が追加レビューを行う場合があります。
- 指摘に対する修正は追加コミットで行い、最終的に `git rebase -i` で整理しても構いません（強制 push の際は通知を忘れずに）。
- CI が導入されている場合はすべてのチェックが成功していることを確認してください。

## コミュニケーション
- 大きめの設計変更や互換性に影響する変更を検討する際は、先に Issue や Discussion で方針を共有してもらえると助かります。
- 機密情報（API キー等）はコミットに含めないでください。
- わからない点や迷った点は遠慮なくコメントしてください。ドキュメントの更新だけでも歓迎です。

継続的な改善への参加を歓迎します。ありがとうございます！
