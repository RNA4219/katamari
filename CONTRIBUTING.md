# Contributing to Katamari

このリポジトリは個人でメンテナンスしている OSS です。変更は最小限・高品質に保ちつつ、誰もが継続的に改善へ参加できるよう以下のルールを設けています。

## ブランチ運用
- `main` は常にデプロイ可能でテスト済みの状態を維持します。直接 push は行わず、必ず Pull Request（PR）経由でマージします。
- 作業ブランチは `feature/<課題番号または日付>-<要約>`、`fix/<課題番号>-<要約>`、`chore/<タスク>-<要約>` の形式で作成し、1 PR = 1 テーマを心がけてください。
- Issue や TASK を起票済みの場合は番号を必ず含め、背景の追跡を容易にします（例: `feature/1234-add-ci-lint`）。
- 長期タスクは `feature/...` ブランチを定期的に `git fetch origin && git rebase origin/main` で更新し、コンフリクトを早期に解消します。マージコミットではなくリベースを推奨します。
- `release/` ブランチはメンテナーが切ります。パッチ適用は `hotfix/<課題>-<要約>` で作業し、`main` と `release/*` 双方へ適用します。
- コミットは最小限の差分でまとめ、レビュー単位が大きすぎる場合は段階的に PR を分割してください。

## 開発環境セットアップ
1. Python 依存関係を `pip install -r requirements.txt` で導入します。評価用ツールが必要な場合は `requirements-eval.txt` も参照してください。
2. Node.js まわりを触る場合は `pnpm install` を実行してください。
3. pre-commit を使用する場合は `pip install pre-commit && pre-commit install` でフックを設定できます。
4. 追加のセットアップが必要なときは `RUNBOOK.md` と `docs/` を参照してください。

## テストと Lint の実行（必須）
TDD を推奨し、実装前にテストを追加してからコードを変更してください。PR を作成する前に下表のチェックをすべて通過させ、結果を PR テンプレートへ貼り付けます。領域外の項目は「対象外」と明記します。

| 対象 | コマンド | 備考 |
| --- | --- | --- |
| Python | `ruff check .` | 自動整形は `ruff format .` を利用可 |
| Python 型チェック | `mypy --strict` | 型エラーをすべて解消してください |
| Python テスト | `pytest -q` | 重要なケースは `tests/` に追加 |
| Node/フロントエンド | `pnpm run lint` | ESM/TS の方針に従いビルドが通ること |
| Node テスト | `pnpm run test` | `node:test` ベースのテストを追加 |

- 追加の静的解析（例: `pnpm run typecheck`）を提供している場合も成功を確認してください。
- 失敗したチェックを無視してマージすることはできません。CI の結果とローカル実行結果が異なる場合は CI ログを引用して調査メモを添えてください。
- データベースや外部サービスが必要な場合は `docs/` や `RUNBOOK.md` に従い、モックを用いたテストを優先します。

## コミットと Pull Request
- コミットメッセージは [Conventional Commits](https://www.conventionalcommits.org/ja/v1.0.0/) を参考にしつつ、簡潔な日本語または英語で要点を 1 行にまとめます。本文では背景・検証内容・フォロータスクを補足してください。
- Pull Request は `.github/pull_request_template.md` を必ず使用し、全項目へ記入します。該当しない場合でも「対象外」「該当なし」と書き、空欄を残さないでください。
- 「テスト実行ログ」には必須コマンドの成功ログ（コマンドと要約結果）を貼り付けます。CI で実行済みの場合も、ローカルまたは CI のリンクを明示します。
- 影響範囲、リリース可否、フォローアップタスク、レビュー観点を箇条書きで整理し、レビュアーがすぐ判断できるようにします。
- Draft PR は作業メモとして活用して構いません。レビュー準備が整ったら Ready for review へ切り替え、レビュアーをアサインしてください。
- 緊急修正でテンプレート項目を省略する必要がある場合は、PR 冒頭に理由と後追いタスクを明記します。

## 改行ポリシー
- ルートの `.gitattributes` で `* text=auto` を設定し、Python/Node/ドキュメントなどは LF、Windows 向けバッチ/PowerShell は CRLF に固定しています。
- 既存ファイルの改行差分が大量に発生した場合は `git add --renormalize .` を別コミットで実行し、フォーマットのみの差分を整理してください。

## レビューとマージ
- レビューは基本的にメンテナーが行いますが、CODEOWNERS に指定された担当者が追加レビューを行う場合があります。
- 指摘に対する修正は追加コミットで行い、最終的に `git rebase -i` で整理しても構いません（強制 push の際は通知を忘れずに）。
- CODEOWNERS が指定されたレビューが揃わない場合はマージできません。必要に応じて `@katamari-org/maintainers` をメンションして調整します。
- CI が導入されている場合はすべてのチェックが成功していることを確認してください。必須チェックが不安定な場合は Issue を作成し、再実行ログを添付してください。

## コミュニケーション
- 大きめの設計変更や互換性に影響する変更を検討する際は、先に Issue や Discussion で方針を共有してもらえると助かります。
- 機密情報（API キー等）はコミットに含めないでください。
- わからない点や迷った点は遠慮なくコメントしてください。ドキュメントの更新だけでも歓迎です。

継続的な改善への参加を歓迎します。ありがとうございます！
