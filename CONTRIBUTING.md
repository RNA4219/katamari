# Contributing to Katamari

このリポジトリは個人でメンテナンスしている OSS です。変更は最小限・高品質に保ちつつ、誰もが継続的に改善へ参加できるよう以下のルールを設けています。

## ブランチ運用
- `main` は常にデプロイ可能な状態を維持します。作業は `feature/<課題>-<要約>` や `fix/<課題>-<要約>` のようなブランチで行い、完了後に Pull Request からマージしてください。
- Issue を起票した場合はブランチ名に Issue 番号を含めると追跡が容易です（例: `feature/1234-add-ci-lint`）。
- `main` へ取り込む前に `git fetch origin && git rebase origin/main` で最新に追随し、競合がない状態を確認してください。
- 小さなステップでコミットし、意味のある単位で PR を分割することでレビューを円滑にします。

## 開発環境セットアップ
1. Python 依存関係を `pip install -r requirements.txt` で導入します。評価用ツールが必要な場合は `requirements-eval.txt` も参照してください。
2. Node.js まわりを触る場合は `pnpm install` を実行してください。
3. pre-commit を使用する場合は `pip install pre-commit && pre-commit install` でフックを設定できます。
4. 追加のセットアップが必要なときは `RUNBOOK.md` と `docs/` を参照してください。

## テストと Lint の実行
TDD を推奨し、実装前にテストを追加してからコードを変更してください。対象領域に応じて以下を実行します。

| 対象 | コマンド | 備考 |
| --- | --- | --- |
| Python | `ruff check .` | 自動整形は `ruff format .` を利用可 |
| Python 型チェック | `mypy --strict` | 型エラーをすべて解消してください |
| Python テスト | `pytest -q` | 重要なケースは `tests/` に追加 |
| Node/フロントエンド | `pnpm run lint` | ESM/TS の方針に従いビルドが通ること |
| Node テスト | `pnpm run test` | `node:test` ベースのテストを追加 |

PR テンプレートの「テスト実行ログ」欄には成功を確認できる 1 行以上の結果を貼り付けてください。対象外の領域は「対象外」と明記します。

## ADR を追加・更新する手順
1. `docs/adr/0000-template.md` をコピーし、`docs/adr/NNNN-<要約>.md`（4 桁ゼロ埋め）というファイル名で保存します。番号は `docs/adr/README.md` の最新値から連番で採番します。
2. `Context`/`Decision`/`Consequences`/`Status`/`DoD` をすべて埋めます。背景リンクと DoD チェックリストは必須で、マイルストーン ADR の場合は `docs/katamari_wbs.csv` と整合させます。
3. 既存 ADR や仕様書への参照がある場合はリンクを貼り、フォローアップタスクがあるときは `DoD` のチェック項目に「Follow-up」として明記します。
4. `docs/adr/README.md` と関連ハブ (`docs/ROADMAP_AND_SPECS.md`) のテーブル・リンクを更新し、新旧の整合性を確認します。
5. PR では本手順を満たしたことを記載し、レビュワーが DoD の達成状況を検証できるよう関連テストや証跡を提示します。

## コミットと Pull Request
- コミットメッセージは簡潔な日本語または英語で要点を 1 行にまとめ、必要に応じて本文で背景を補足します。
- Pull Request はテンプレートを必ず使用し、未対応の項目は「未実施」「対象外」など明示的に記入してください。
- 変更点、動作確認、影響範囲、レビューしてほしいポイントをそれぞれ短く記述するとレビューがスムーズです。
- Draft PR は作業メモとして活用して構いません。レビュー準備が整ったら Ready for review へ切り替えてください。

## 改行ポリシー
- ルートの `.gitattributes` で `* text=auto` を設定し、Python/Node/ドキュメントなどは LF、Windows 向けバッチ/PowerShell は CRLF に固定しています。
- 既存ファイルの改行差分が大量に発生した場合は `git add --renormalize .` を別コミットで実行し、フォーマットのみの差分を整理してください。
- 新規ファイルや外部から持ち込むコードも `.gitattributes` のポリシーに合わせ、CRLF が混入していないかをコミット前に確認してください。

## レビューとマージ
- レビューは基本的にメンテナーが行いますが、CODEOWNERS に指定された担当者が追加レビューを行う場合があります。
- 指摘に対する修正は追加コミットで行い、最終的に `git rebase -i` で整理しても構いません（強制 push の際は通知を忘れずに）。
- CI が導入されている場合はすべてのチェックが成功していることを確認してください。

## コミュニケーション
- 大きめの設計変更や互換性に影響する変更を検討する際は、先に Issue や Discussion で方針を共有してもらえると助かります。
- 機密情報（API キー等）はコミットに含めないでください。
- わからない点や迷った点は遠慮なくコメントしてください。ドキュメントの更新だけでも歓迎です。

継続的な改善への参加を歓迎します。ありがとうございます！
