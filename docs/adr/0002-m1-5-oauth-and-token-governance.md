# ADR 0002: M1.5 OAuth とトークンガバナンス

- ステータス: Accepted
- 対象マイルストーン: M1.5

## 目的
- 本番向け OAuth 認証フローを導入し、ヘッダー認証からの段階移行を完了する。
- 推論コストの精緻な把握のため、厳密なトークンカウントと UI 表示を整備する。

## スコープ
- OAuth リダイレクト・コールバックの実装と Chainlit 設定の更新。
- 既存 Header Auth と共存するトグル制御、および遷移計画の提示。
- 厳密なトークンカウンタ（入力・出力・保持率補正）の導入と UI 表示更新。
- OAuth 完了後に `/metrics` へセッション統計を送出。

## 受け入れ条件
1. AC-04 の後段要件に従い、OAuth がデフォルト認証として稼働すること。
2. 要件書 FR-07 のメトリクス要件が OAuth 導入後も満たされること。
3. WBS M1.5-1（OAuth enable）と M1.5-2（Strict token counting）の作業完了条件が充足されること。

## DoD チェックリスト
- [ ] OAuth 認証フローで 302 リダイレクト → 200 コールバック完了を確認する統合テストがある。
- [ ] 失敗時に再試行可能なエラーと不可エラーを既存 error 階層で分類する例外ハンドリングが実装されている。
- [ ] Token in/out・保持率補正値が UI と `/metrics` 双方で整合することを検証するスナップショット/単体テストが存在する。
- [ ] Header Auth フラグを無効化しても OAuth が唯一の認証経路として機能する設定が確認できる。
- [ ] ドキュメントに OAuth クライアント登録手順と Chainlit 設定差分が追記されている。

## 関連ドキュメント
- docs/Katamari_Requirements_v3_ja.md（AC-04, FR-07）
- docs/katamari_wbs.csv（M1.5-1, M1.5-2）
- docs/addenda/G_Security_Privacy.md（認証方針）
