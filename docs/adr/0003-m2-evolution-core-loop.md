# ADR 0003: M2 プロンプト進化コアループ

- ステータス: Accepted
- 対象マイルストーン: M2

## 目的
- `/evolve` エンドポイントでプロンプト進化ループを実装し、BERTScore/ROUGE/ルール評価を順次適用する。
- 進化結果をスコアボード UI で可視化し、意思決定を支援する。

## スコープ
- 進化候補生成、評価パイプライン、ベストプロンプト更新ロジック。
- 評価指標の重み付け・閾値設定、および異常検知時のフェイルセーフ。
- スコアボード UI の表示要素（評価履歴、保持率、勝者プロンプト）。
- `/evolve` の認証・レート制御を既存ポリシーに揃える。

## 受け入れ条件
1. 要件書 FR-08 に基づき、`/evolve` が評価順（BERTScore→ROUGE→ルール）で動作すること。
2. 進化結果が Scoreboard UI に反映され、最新の最良プロンプトを明示できること。
3. WBS M2-1〜M2-5（進化ループと各評価器、UI）の完了条件が満たされること。

## DoD チェックリスト
- [ ] `/evolve` の API テストが 200 OK と最良プロンプトの更新を確認し、無効入力時には再試行不可エラーを返す。
- [ ] BERTScore・ROUGE・ルール評価それぞれに対する単体テストが閾値と重み付けを検証する。
- [ ] スコアボード UI のスナップショットテストで評価履歴・保持率・勝者表示が確認できる。
- [ ] `/metrics` へ進化サイクル数・ベスト更新回数をエクスポートし、Prometheus 収集テストが存在する。
- [ ] フェイルセーフ時に前回の安定プロンプトへロールバックする統合テストが追加されている。

## 関連ドキュメント
- docs/Katamari_Requirements_v3_ja.md（FR-08）
- docs/katamari_wbs.csv（M2-1, M2-2, M2-3, M2-4, M2-5）
- docs/addenda/D_Trim_Design.md（進化と保持率の関連）
