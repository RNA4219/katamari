# ADR 0004: M2.5 永続化とハイブリッドメモリ

- ステータス: Accepted
- 対象マイルストーン: M2.5

## 目的
- Postgres 永続化を導入し、会話履歴と進化ログを安定保管する。
- 永続メモリとインメモリ推論を組み合わせたハイブリッド RAG を実現する。

## スコープ
- Postgres スキーマ設計（会話、評価、メトリクスの各テーブル）とマイグレーション管理。
- 読み書きのリポジトリ層実装とリトライ戦略。
- 永続層を利用するハイブリッド RAG（メモリ/RAG Hybrid）ロジックとキャッシュ制御。
- データ保持ポリシー（削除 API、保持期間設定）の実装。
- `/metrics` で永続化キュー長・失敗率の公開。

## 受け入れ条件
1. 要件書 M2.5 項で示される Postgres 永続化が実環境で稼働すること。
2. AC-05 のライセンス要件を満たしつつ、DB スキーマとマイグレーションが管理されること。
3. WBS M2.5-1 の完了条件（Postgres persistence）が満たされ、M3 以降への前提が整うこと。

## DoD チェックリスト
- [ ] マイグレーションが idempotent に適用される自動テスト（apply → rollback → re-apply）が存在する。
- [ ] DB 障害時に再試行可能な例外と非再試行例外が既存 error 階層へマッピングされている。
- [ ] 永続層を利用する読み書きが統合テストで検証され、`/metrics` で成功/失敗カウンタが 200 OK 応答に含まれる。
- [ ] データ削除 API が保持期間設定に基づき 200/404 を返すテストが追加されている。
- [ ] セキュリティドキュメントへデータ保持ポリシーと運用フローの追記が完了している。

## 関連ドキュメント
- docs/Katamari_Requirements_v3_ja.md（M2.5 項、AC-05）
- docs/katamari_wbs.csv（M2.5-1）
- docs/addenda/D_Trim_Design.md（Memory/RAG Hybrid）
- docs/addenda/G_Security_Privacy.md（データ保持方針）
