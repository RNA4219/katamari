# ADR-0005: M1.5 OAuth とトークンガバナンスを導入する

## Context
- 背景: M1.5 では Header 認証から OAuth への段階移行と、トークン使用量の厳密な把握が求められる。
- 課題: 現状のヘッダー認証は本番利用に耐えず、トークンカウントも概算のままでコスト予測が困難。
- 参考資料: [`docs/Katamari_Requirements_v3_ja.md`](../Katamari_Requirements_v3_ja.md) の AC-04 後段、FR-07。`docs/katamari_wbs.csv` の M1.5-1, M1.5-2。

## Decision
- 方針: OAuth 2.0 認可コードフローを標準化し、Header 認証との共存トグルを設計。トークンカウンタは ADR-0002 の tiktoken 実測値に統一する。
- 採用理由: 本番運用でのセキュリティ担保と課金最適化を同時に達成するため。移行期間は Feature Flag で後方互換を維持する。
- 適用範囲: 認証ルーティング、UI 表示、メトリクス送出、Chainlit 設定ドキュメントの更新。

## Consequences
- 影響範囲: OAuth クライアント設定とセッション管理が追加され、`/metrics` へのセッション統計送出が可能になる。
- 利点: 再認証フローがユーザー体験を損なわずに実装でき、トークン使用量の精度が向上する。
- リスク/フォローアップ: OAuth プロバイダ依存の障害に備えたフェイルセーフ設計が必要。Header 認証廃止時期を別途 ADR で管理する。

## Status
- ステータス: 承認済み
- 最終更新日: 2025-02-14

## DoD
- [ ] OAuth 認証フロー（302 リダイレクト→200 コールバック）を検証する統合テストが存在する。
- [ ] 失敗時に再試行可能なエラーと不可エラーを既存 error 階層で分類する例外ハンドリングが実装されている。
- [ ] Token in/out・保持率補正値が UI と `/metrics` で整合するスナップショット/単体テストが追加されている。
- [ ] Header Auth フラグ無効化時に OAuth が唯一の認証経路として機能する設定が検証されている。
- [ ] OAuth クライアント登録手順と Chainlit 設定差分がドキュメントに追記されている。
